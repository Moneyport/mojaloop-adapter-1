sequenceDiagram
    participant Payer FSP
    participant Moja Switch
    participant ALS
    participant Adapter
    participant Redis
    participant TCP Relay
    participant Legacy Switch
    participant ATM

Note right of ATM: User selects <br> Moja Cashout <br> Enters amount and<br> MSISDN
ATM ->> Legacy Switch: Request for cash out

Legacy Switch ->> TCP Relay: Legacy Authorization Request
Note over TCP Relay: Convert to JSON <br> Field mapping

TCP Relay ->> Redis: Queue to be processed
Redis ->> Adapter: Pick up message
Note over Adapter, Redis: Duplicate checks <br> Create transaction and legacy fees <br> Map transaction to legacy key

Adapter ->> ALS: GET parties/MSISDN/<msisdn>
ALS -->> Adapter: 202 Accepted
ALS ->> Adapter: PUT parties/MSISDN/<msisdn> 
Adapter -->> ALS: 200 Ok
Note over Adapter: Update payer info
 
Adapter ->> Moja Switch: POST /transactionRequests
Moja Switch -->> Adapter: 202 Accepted
Moja Switch ->> Payer FSP : POST /transactionRequests
Payer FSP -->> Moja Switch: 202 Accepted

Note left of Payer FSP: Create transaction <br> Generate quote ID

Payer FSP ->> Moja Switch: PUT /transactionRequests/<ID> <br> transactionId = <tx ID>
Moja Switch -->> Payer FSP: 200 Ok
Moja Switch ->> Adapter: PUT /transactionRequests/<txReqId> <br> transactionId = <tx ID>
Adapter -->> Moja Switch: 200 Ok

Note over Adapter: Store transactionId

Payer FSP ->> Moja Switch: POST /quotes
Moja Switch -->> Payer FSP: 202 Accepted
Moja Switch ->> Adapter: POST /qoutes
Adapter -->> Moja Switch: 202 Accepted

Note over Adapter: Create quote <br> Generate condition <br> Calculate fees

Adapter ->> Moja Switch: PUT /qoutes
Moja Switch -->> Adapter: 200 Ok
Moja Switch ->> Payer FSP: PUT /quotes
Payer FSP -->> Moja Switch: 200 Ok

Payer FSP ->> Moja Switch: GET /authorizations/<transactionRequestId>
Moja Switch -->> Payer FSP: 202 Accepted
Moja Switch ->> Adapter: Get /authorizations/<transactionRequestId>

Adapter ->> Moja Switch: 202 Accepted

Note over Adapter: Find correct relay
Adapter ->> Redis: Queue to be processed
Redis ->> TCP Relay: Pick up message
Note over TCP Relay, Legacy Switch: Convert to <br> Legacy Authorization Response
TCP Relay ->> Legacy Switch: Legacy Authorization Response

Legacy Switch ->> ATM: Legacy Authorization Response
Note right of ATM: Display quote